---
'${var.deploy_fence_db && var.deploy_rds ? 1 : 0}'
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.16.2
  name: dbinstances.rds.services.k8s.aws
spec:
  group: rds.services.k8s.aws
  names:
    kind: DBInstance
    listKind: DBInstanceList
    plural: dbinstances
    singular: dbinstance
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.dbInstanceStatus
      name: STATUS
      type: string
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: DBInstance is the Schema for the DBInstances API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: |-
              DBInstanceSpec defines the desired state of DBInstance.

              Contains the details of an Amazon RDS DB instance.

              This data type is used as a response element in the operations CreateDBInstance,
              CreateDBInstanceReadReplica, DeleteDBInstance, DescribeDBInstances, ModifyDBInstance,
              PromoteReadReplica, RebootDBInstance, RestoreDBInstanceFromDBSnapshot, RestoreDBInstanceFromS3,
              RestoreDBInstanceToPointInTime, StartDBInstance, and StopDBInstance.
            properties:
              allocatedStorage: 10
              # allow_major_version_upgrade: true/deprecated
              autoMinorVersionUpgrade: true
              backupRetentionPeriod: 4
              copyTagsToSnapshot: true
              dbInstanceClass: db.t3.small
              dbInstanceIdentifier: Commons1-fencedb
              dbName: fence
              dbParameterGroupName: ${aws_db_parameter_group.rds-cdis-pg.name}
              dbSnapshotIdentifier: ${replace(var.vpc_name, "_", "-")}-fencedb
              dbSubnetGroupName: ${aws_db_subnet_group.private_group.id}
              deletionProtection: true
              engine: postgres
              engineVersion: 13
              masterUserPassword: '${var.db_password_fence != "" ? var.db_password_fence : random_password.fence_password.result}'
              masterUsername: fence_user
              maxAllocatedStorage: 0
              multiAZ: false
              preferredBackupWindow: 06:00-06:59
              preferredMaintenanceWindow: SAT:09:00-SAT:09:59
              storageEncrypted: true
              storageType: gp2
              tags: 
                key: Environment
                value: Commons1
                key: Organization
                value: Basic Services
              vpcSecurityGroupIDs: ${module.cdis_vpc.security_group_local_id}

---
'${var.deploy_sheepdog_db && var.deploy_rds ? 1 : 0}'
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.16.2
  name: dbinstances.rds.services.k8s.aws
spec:
  group: rds.services.k8s.aws
  names:
    kind: DBInstance
    listKind: DBInstanceList
    plural: dbinstances
    singular: dbinstance
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.dbInstanceStatus
      name: STATUS
      type: string
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: DBInstance is the Schema for the DBInstances API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: |-
              DBInstanceSpec defines the desired state of DBInstance.

              Contains the details of an Amazon RDS DB instance.

              This data type is used as a response element in the operations CreateDBInstance,
              CreateDBInstanceReadReplica, DeleteDBInstance, DescribeDBInstances, ModifyDBInstance,
              PromoteReadReplica, RebootDBInstance, RestoreDBInstanceFromDBSnapshot, RestoreDBInstanceFromS3,
              RestoreDBInstanceToPointInTime, StartDBInstance, and StopDBInstance.
            properties:
              allocatedStorage: 10
              # allow_major_version_upgrade: true/deprecated
              autoMinorVersionUpgrade: true
              backupRetentionPeriod: 4
              copyTagsToSnapshot: true
              dbInstanceClass: db.t3.small
              dbInstanceIdentifier: Commons1-sheepdog
              dbName: gdcapi
              dbParameterGroupName: ${aws_db_parameter_group.rds-cdis-pg.name}
              dbSnapshotIdentifier: ${replace(var.vpc_name, "_", "-")}-sheepdogdb
              dbSubnetGroupName: ${aws_db_subnet_group.private_group.id}
              deletionProtection: true
              engine: postgres
              engineVersion: 13
              masterUserPassword: '${var.db_password_sheepdog != "" ? var.db_password_sheepdog : random_password.sheepdog_password.result}'
              masterUsername: sheepdog
              maxAllocatedStorage: 0
              multiAZ: false
              preferredBackupWindow: 07:00-07:59
              preferredMaintenanceWindow: SAT:10:00-SAT:10:59
              storageEncrypted: true
              storageType: gp2
              tags: 
                key: Environment
                value: Commons1
                key: Organization
                value: Basic Services
              vpcSecurityGroupIDs: ${module.cdis_vpc.security_group_local_id}

---
'${var.deploy_indexd_db && var.deploy_rds ? 1 : 0}'
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.16.2
  name: dbinstances.rds.services.k8s.aws
spec:
  group: rds.services.k8s.aws
  names:
    kind: DBInstance
    listKind: DBInstanceList
    plural: dbinstances
    singular: dbinstance
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.dbInstanceStatus
      name: STATUS
      type: string
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: DBInstance is the Schema for the DBInstances API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: |-
              DBInstanceSpec defines the desired state of DBInstance.

              Contains the details of an Amazon RDS DB instance.

              This data type is used as a response element in the operations CreateDBInstance,
              CreateDBInstanceReadReplica, DeleteDBInstance, DescribeDBInstances, ModifyDBInstance,
              PromoteReadReplica, RebootDBInstance, RestoreDBInstanceFromDBSnapshot, RestoreDBInstanceFromS3,
              RestoreDBInstanceToPointInTime, StartDBInstance, and StopDBInstance.
            properties:
              allocatedStorage: 10
              # allow_major_version_upgrade: true/deprecated
              autoMinorVersionUpgrade: true
              backupRetentionPeriod: 4
              copyTagsToSnapshot: true
              dbInstanceClass: db.t3.small
              dbInstanceIdentifier: Commons1-indexddb
              dbName: indexd
              dbParameterGroupName: ${aws_db_parameter_group.rds-cdis-pg.name}
              dbSnapshotIdentifier: ${replace(var.vpc_name, "_", "-")}-indexddb
              dbSubnetGroupName: ${aws_db_subnet_group.private_group.id}
              deletionProtection: true
              engine: postgres
              engineVersion: 13
              masterUserPassword: '${var.db_password_indexd != "" ? var.db_password_indexd : random_password.indexd_password.result}'
              masterUsername: indexd_user
              maxAllocatedStorage: 0
              multiAZ: false
              preferredBackupWindow: 08:00-08:59
              preferredMaintenanceWindow: SAT:11:00-SAT:11:59
              storageEncrypted: true
              storageType: gp2
              tags: 
                key: Environment
                value: Commons1
                key: Organization
                value: Basic Services
              vpcSecurityGroupIDs: ${module.cdis_vpc.security_group_local_id}

