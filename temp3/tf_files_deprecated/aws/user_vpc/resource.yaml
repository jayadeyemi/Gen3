---
resource:
  aws_key_pair:
    automation_dev:
      key_name: ${var.vpc_name}_automation_dev
      public_key: ${var.ssh_public_key}
  aws_security_group:
    login-ssh:
      name: login-ssh
      description: security group that only enables ssh from login node
      vpc_id: ${module.cdis_vpc.vpc_id}
      ingress:
        from_port: 22
        to_port: 22
        protocol: TCP
        cidr_blocks:
          ${aws_instance.login.private_ip}/32
          ${var.csoc_cidr}
      tags:
        Environment: ${var.vpc_name}
        Organization: Basic Service
  aws_security_group:
    ssh:
      name: ssh
      description: security group that only enables ssh
      vpc_id: ${module.cdis_vpc.vpc_id}
      ingress:
        from_port: 22
        to_port: 22
        protocol: TCP
        cidr_blocks:
          0.0.0.0/0
      tags:
        Environment: ${var.vpc_name}
        Organization: Basic Service
  aws_instance:
    login:
      ami: ${module.cdis_vpc.login_ami_id}
      subnet_id: ${module.cdis_vpc.public_subnet_id}
      instance_type: t2.micro
      monitoring: true
      key_name: ${aws_key_pair.automation_dev.key_name}
      vpc_security_group_ids:
        ${aws_security_group.ssh.id}
        ${module.cdis_vpc.security_group_local_id}
      iam_instance_profile: ${module.cdis_vpc.logging_profile_name}
      tags:
        Name: ${var.vpc_name} Login Node
        Environment: ${var.vpc_name}
        Organization: Basic Service
      lifecycle:
        ignore_changes:
          ami
          key_name
      user_data: "#!/bin/bash \nsed -i 's/SERVER/login_node-auth-{hostname}-{instance_id}/g' /var/awslogs/etc/awslogs.conf\nsed -i 's/VPC/'${var.vpc_name}'/g' /var/awslogs/etc/awslogs.conf\ncat >> /var/awslogs/etc/awslogs.conf <<EOM\n[syslog]\ndatetime_format = %b %d %H:%M:%S\nfile = /var/log/syslog\nlog_stream_name = login_node-syslog-{hostname}-{instance_id}\ntime_zone = LOCAL\nlog_group_name = ${var.vpc_name}\nEOM\n\nchmod 755 /etc/init.d/awslogs\nsystemctl enable awslogs\nsystemctl restart awslogs"
  aws_eip:
    login:
      vpc: true
  aws_eip_association:
    login_eip:
      instance_id: ${aws_instance.login.id}
      allocation_id: ${aws_eip.login.id}
