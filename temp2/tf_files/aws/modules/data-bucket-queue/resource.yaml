---
resource:
  - aws_sns_topic:
    user_updates:
      name: ${var.bucket_name}_sns_topic
  - aws_sqs_queue:
    user_updates_queue:
      name: ${var.bucket_name}_data_upload
      visibility_timeout_seconds: 300
  - aws_sns_topic_subscription:
    user_updates_sqs_target:
      topic_arn: ${aws_sns_topic.user_updates.arn}
      protocol: sqs
      endpoint: ${aws_sqs_queue.user_updates_queue.arn}
  - aws_s3_bucket_notification:
    bucket_notification:
      count: '${var.configure_bucket_notifications ? 1 : 0}'
      bucket: ${var.bucket_name}
      topic:
        - topic_arn: ${aws_sns_topic.user_updates.arn}
        events:
          - s3:ObjectCreated:Put
          - s3:ObjectCreated:Post
          - s3:ObjectCreated:Copy
          - s3:ObjectCreated:CompleteMultipartUpload
      lifecycle:
        - ignore_changes:
          - ${topic}
  - aws_sqs_queue_policy:
    subscribe_sns:
      queue_url: ${aws_sqs_queue.user_updates_queue.id}
      policy: "{\n  \"Version\": \"2012-10-17\",\n  \"Id\": \"sqspolicy\",\n  \"Statement\": [\n    {\n      \"Sid\": \"100\",\n      \"Effect\": \"Allow\",\n      \"Principal\": \"*\",\n      \"Action\": \"sqs:SendMessage\",\n      \"Resource\": \"${aws_sqs_queue.user_updates_queue.arn}\",\n      \"Condition\": {\n        \"ArnEquals\": {\n          \"aws:SourceArn\": \"${aws_sns_topic.user_updates.arn}\"\n        }\n      }\n    }\n  ]\n}"
  - aws_sns_topic_policy:
    default:
      arn: ${aws_sns_topic.user_updates.arn}
      policy: ${data.aws_iam_policy_document.sns-topic-policy.json}
