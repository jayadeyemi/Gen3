---
data:
  - aws_iam_policy_document:
    cwltok_policy_document:
      statement:
        - actions:
          - kinesis:PutRecord
        effect: Allow
        resources:
          - ${aws_kinesis_stream.common_stream.arn}
        - actions:
          - iam:PassRole
        effect: Allow
        resources:
          - ${aws_iam_role.cwl_to_kinesis_role.arn}
  - aws_iam_policy_document:
    common_logs_destination_policy:
      statement:
        - effect: Allow
        principals:
          type: AWS
          identifiers:
            - ${var.child_account_id}
        actions:
          - logs:PutSubscriptionFilter
        resources:
          - ${aws_cloudwatch_log_destination.common_logs_destination.arn}
  - aws_iam_policy_document:
    firehose_policy_document:
      statement:
        - actions:
          - s3:ListBucketMultipartUploads
          - s3:ListBucket
          - s3:PutObject
          - s3:GetObject
          - s3:AbortMultipartUpload
          - s3:GetBucketLocation
        effect: Allow
        resources:
          - ${aws_s3_bucket.common_logging_bucket.arn}
          - ${aws_s3_bucket.common_logging_bucket.arn}/*
        - actions:
          - logs:*
        effect: Allow
        resources:
          - '*'
        - actions:
          - es:*
        effect: Allow
        resources:
          - '*'
  - aws_iam_policy_document:
    lambda_policy_document:
      statement:
        - actions:
          - logs:*
        effect: Allow
        resources:
          - '*'
        - actions:
          - kinesis:Get*
          - kinesis:List*
          - kinesis:Describe*
        effect: Allow
        resources:
          - ${aws_kinesis_stream.common_stream.arn}
        - actions:
          - firehose:PutRecordBatch
          - firehose:PutRecord
        effect: Allow
        resources:
          - ${aws_kinesis_firehose_delivery_stream.firehose_to_es.arn}
          - ${aws_kinesis_firehose_delivery_stream.firehose_to_s3.arn}
  - archive_file:
    lambda_function:
      type: zip
      source_file: ${path.module}/lambda_function.py
      output_path: lambda_function_payload.zip
