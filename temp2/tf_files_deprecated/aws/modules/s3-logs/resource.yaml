---
resource:
  - aws_s3_bucket:
    log_bucket:
      bucket: ${local.clean_bucket_name}
      acl: log-delivery-write
      server_side_encryption_configuration:
        - rule:
          - apply_server_side_encryption_by_default:
            - sse_algorithm: AES256
      lifecycle_rule:
        - id: log
        enabled: true
        prefix: /
        tags:
          rule: log
          autoclean: 'true'
        expiration:
          - days: 1825
      tags:
        Name: ${local.clean_bucket_name}
        Environment: ${var.environment}
        Purpose: logs bucket
  - aws_s3_bucket_public_access_block:
    s3-log_bucket_privacy:
      bucket: ${aws_s3_bucket.log_bucket.id}
      block_public_acls: true
      block_public_policy: true
      ignore_public_acls: true
      restrict_public_buckets: true
  - aws_iam_policy:
    log_bucket_writer:
      name: bucket_writer_${local.clean_bucket_name}
      description: Read or write ${local.clean_bucket_name}
      policy: ${data.aws_iam_policy_document.log_bucket_writer.json}
  - aws_s3_bucket_policy:
    log_bucket_writer_by_ct:
      bucket: ${aws_s3_bucket.log_bucket.id}
      policy: "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"AWSCloudTrailAclCheck20150319\",\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n         \"Service\": \"cloudtrail.amazonaws.com\"\n      },\n      \"Action\": \"s3:GetBucketAcl\",\n      \"Resource\": \"${aws_s3_bucket.log_bucket.arn}\"\n    },\n    {\n      \"Sid\": \"AWSCloudTrailWrite20150319\",\n     \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"cloudtrail.amazonaws.com\"\n      },\n      \"Action\": \"s3:PutObject\",\n      \"Resource\": \"${aws_s3_bucket.log_bucket.arn}/*\",\n      \"Condition\": {\n         \"StringEquals\": {\n         \"s3:x-amz-acl\": \"bucket-owner-full-control\"\n         }\n      }\n    }\n  ]\n}"
