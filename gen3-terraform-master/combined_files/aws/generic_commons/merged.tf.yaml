data:
- aws_availability_zones:
    available: {}
- aws_caller_identity:
    current: {}
- aws_ecrpublic_authorization_token:
    token: {}
- aws_rds_engine_version:
    postgresql:
      engine: aurora-postgresql
      version: '14.5'
- aws_iam_policy_document:
    aws_load_balancer_controller:
      statement:
      - actions:
        - iam:CreateServiceLinkedRole
        condition:
        - test: StringEquals
          values:
          - elasticloadbalancing.amazonaws.com
          variable: iam:AWSServiceName
        effect: Allow
        resources:
        - '*'
      - actions:
        - ec2:DescribeAccountAttributes
        - ec2:DescribeAddresses
        - ec2:DescribeAvailabilityZones
        - ec2:DescribeInternetGateways
        - ec2:DescribeVpcs
        - ec2:DescribeVpcPeeringConnections
        - ec2:DescribeSubnets
        - ec2:DescribeSecurityGroups
        - ec2:DescribeInstances
        - ec2:DescribeNetworkInterfaces
        - ec2:DescribeTags
        - ec2:GetCoipPoolUsage
        - ec2:DescribeCoipPools
        - elasticloadbalancing:DescribeLoadBalancers
        - elasticloadbalancing:DescribeLoadBalancerAttributes
        - elasticloadbalancing:DescribeListeners
        - elasticloadbalancing:DescribeListenerCertificates
        - elasticloadbalancing:DescribeSSLPolicies
        - elasticloadbalancing:DescribeRules
        - elasticloadbalancing:DescribeTargetGroups
        - elasticloadbalancing:DescribeTargetGroupAttributes
        - elasticloadbalancing:DescribeTargetHealth
        - elasticloadbalancing:DescribeTags
        effect: Allow
        resources:
        - '*'
      - actions:
        - cognito-idp:DescribeUserPoolClient
        - acm:ListCertificates
        - acm:DescribeCertificate
        - iam:ListServerCertificates
        - iam:GetServerCertificate
        - waf-regional:GetWebACL
        - waf-regional:GetWebACLForResource
        - waf-regional:AssociateWebACL
        - waf-regional:DisassociateWebACL
        - wafv2:GetWebACL
        - wafv2:GetWebACLForResource
        - wafv2:AssociateWebACL
        - wafv2:DisassociateWebACL
        - shield:GetSubscriptionState
        - shield:DescribeProtection
        - shield:CreateProtection
        - shield:DeleteProtection
        effect: Allow
        resources:
        - '*'
      - actions:
        - ec2:AuthorizeSecurityGroupIngress
        - ec2:RevokeSecurityGroupIngress
        effect: Allow
        resources:
        - '*'
      - actions:
        - ec2:CreateSecurityGroup
        effect: Allow
        resources:
        - '*'
      - actions:
        - ec2:CreateTags
        condition:
        - test: StringEquals
          values:
          - CreateSecurityGroup
          variable: ec2:CreateAction
        - test: 'Null'
          values:
          - 'false'
          variable: aws:RequestTag/elbv2.k8s.aws/cluster
        effect: Allow
        resources:
        - arn:aws:ec2:*:*:security-group/*
      - actions:
        - ec2:AuthorizeSecurityGroupIngress
        - ec2:RevokeSecurityGroupIngress
        - ec2:DeleteSecurityGroup
        condition:
        - test: 'Null'
          values:
          - 'false'
          variable: ec2:ResourceTag/elbv2.k8s.aws/cluster
        effect: Allow
        resources:
        - '*'
      - actions:
        - elasticloadbalancing:CreateLoadBalancer
        - elasticloadbalancing:CreateTargetGroup
        condition:
        - test: 'Null'
          values:
          - 'false'
          variable: aws:RequestTag/elbv2.k8s.aws/cluster
        effect: Allow
        resources:
        - '*'
      - actions:
        - elasticloadbalancing:CreateListener
        - elasticloadbalancing:DeleteListener
        - elasticloadbalancing:CreateRule
        - elasticloadbalancing:DeleteRule
        effect: Allow
        resources:
        - '*'
      - actions:
        - elasticloadbalancing:AddTags
        - elasticloadbalancing:RemoveTags
        condition:
        - test: 'Null'
          values:
          - 'true'
          variable: aws:RequestTag/elbv2.k8s.aws/cluster
        - test: 'Null'
          values:
          - 'false'
          variable: aws:ResourceTag/elbv2.k8s.aws/cluster
        effect: Allow
        resources:
        - arn:aws:elasticloadbalancing:*:*:targetgroup/*/*
        - arn:aws:elasticloadbalancing:*:*:loadbalancer/net/*/*
        - arn:aws:elasticloadbalancing:*:*:loadbalancer/app/*/*
      - actions:
        - elasticloadbalancing:AddTags
        - elasticloadbalancing:RemoveTags
        effect: Allow
        resources:
        - arn:aws:elasticloadbalancing:*:*:listener/net/*/*/*
        - arn:aws:elasticloadbalancing:*:*:listener/app/*/*/*
        - arn:aws:elasticloadbalancing:*:*:listener-rule/net/*/*/*
        - arn:aws:elasticloadbalancing:*:*:listener-rule/app/*/*/*
      - actions:
        - elasticloadbalancing:ModifyLoadBalancerAttributes
        - elasticloadbalancing:SetIpAddressType
        - elasticloadbalancing:SetSecurityGroups
        - elasticloadbalancing:SetSubnets
        - elasticloadbalancing:DeleteLoadBalancer
        - elasticloadbalancing:ModifyTargetGroup
        - elasticloadbalancing:ModifyTargetGroupAttributes
        - elasticloadbalancing:DeleteTargetGroup
        condition:
        - test: StringEquals
          values:
          - 'false'
          variable: aws:ResourceTag/elbv2.k8s.aws/cluster
        effect: Allow
        resources:
        - '*'
      - actions:
        - elasticloadbalancing:RegisterTargets
        - elasticloadbalancing:DeregisterTargets
        effect: Allow
        resources:
        - arn:aws:elasticloadbalancing:*:*:targetgroup/*/*
      - actions:
        - elasticloadbalancing:SetWebAcl
        - elasticloadbalancing:ModifyListener
        - elasticloadbalancing:AddListenerCertificates
        - elasticloadbalancing:RemoveListenerCertificates
        - elasticloadbalancing:ModifyRule
        effect: Allow
        resources:
        - '*'
- aws_iam_policy_document:
    alb_ingress_controller_assume_role:
      statement:
      - actions:
        - sts:AssumeRole
        effect: Allow
        principals:
        - identifiers:
          - ec2.amazonaws.com
          type: Service
      - actions:
        - sts:AssumeRoleWithWebIdentity
        condition:
        - test: StringEquals
          values:
          - sts.amazonaws.com
          variable: ${module.eks.oidc_provider}:aud
        - test: StringEquals
          values:
          - system:serviceaccount:kube-system:aws-load-balancer-controller
          variable: ${module.eks.oidc_provider}:sub
        effect: Allow
        principals:
        - identifiers:
          - ${module.eks.oidc_provider_arn}
          type: Federated
---
locals:
- azs: ${slice(data.aws_availability_zones.available.names, 0, 3)}
  tags:
    Name: ${var.vpc_name}
    Organization: Basic Services
module:
- eks:
    aws_auth_roles:
    - groups:
      - system:bootstrappers
      - system:nodes
      rolearn: ${module.karpenter.role_arn}
      username: system:node:{{EC2PrivateDNSName}}
    cluster_addons:
      coredns:
        configuration_values: '${jsonencode({"computeType": "Fargate", "resources":
          {"limits": {"cpu": "0.25", "memory": "256M"}, "requests": {"cpu": "0.25",
          "memory": "256M"}}})}'
      kube-proxy: {}
      vpc-cni: {}
    cluster_endpoint_public_access: true
    cluster_name: ${var.vpc_name}
    cluster_version: ${var.eks_version}
    control_plane_subnet_ids: ${module.vpc.intra_subnets}
    create_cluster_security_group: false
    create_node_security_group: false
    fargate_profiles:
      karpenter:
        selectors:
        - namespace: karpenter
      kube-system:
        selectors:
        - namespace: kube-system
    manage_aws_auth_configmap: true
    source: terraform-aws-modules/eks/aws
    subnet_ids: ${module.vpc.private_subnets}
    tags: '${merge(local.tags, {"karpenter.sh/discovery": "${var.vpc_name}"})}'
    vpc_id: ${module.vpc.vpc_id}
- karpenter:
    cluster_name: ${module.eks.cluster_name}
    irsa_oidc_provider_arn: ${module.eks.oidc_provider_arn}
    policies:
      AmazonSSMManagedInstanceCore: arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
    source: terraform-aws-modules/eks/aws//modules/karpenter
    tags: ${local.tags}
- vpc:
    azs: ${local.azs}
    cidr: ${var.vpc_cidr}
    create_database_subnet_group: false
    database_subnet_tags:
      Name: private_db_alt
    database_subnets:
    - ${cidrsubnet(var.vpc_cidr, 8, 198)}
    enable_nat_gateway: true
    intra_subnets: '${[for k , v in local.azs : cidrsubnet(var.vpc_cidr, 8, k + 195)]}'
    name: ${var.vpc_name}
    private_subnet_tags:
      karpenter.sh/discovery: ${var.vpc_name}
      kubernetes.io/role/internal-elb: 1
    private_subnets: '${[for k , v in local.azs : cidrsubnet(var.vpc_cidr, 2, k)]}'
    public_subnet_tags:
      kubernetes.io/role/elb: 1
    public_subnets: '${[for k , v in local.azs : cidrsubnet(var.vpc_cidr, 8, k + 192)]}'
    single_nat_gateway: true
    source: terraform-aws-modules/vpc/aws
    tags: ${local.tags}
    version: ~> 5.0
- es:
    depends_on:
    - ${module.vpc}
    - ${aws_cloudwatch_log_group.main_log_group}
    es_linked_role: false
    source: git::git@github.com:uc-cdis/cloud-automation.git//tf_files-1.0/aws/commons_vpc_es?ref=44404bf7b3a68c2eff31972a4de3b2d987d7a142
    vpc_name: ${var.vpc_name}
- aurora_postgresql_v2:
    apply_immediately: true
    db_subnet_group_name: ${aws_db_subnet_group.database.name}
    engine: ${data.aws_rds_engine_version.postgresql.engine}
    engine_mode: provisioned
    engine_version: ${data.aws_rds_engine_version.postgresql.version}
    instance_class: db.serverless
    instances:
      one: {}
    manage_master_user_password: false
    master_password: ${random_password.master.result}
    master_username: postgres
    monitoring_interval: 60
    name: ${var.vpc_name}-postgres-cluster
    security_group_rules:
      vpc_ingress:
        cidr_blocks: ${module.vpc.private_subnets_cidr_blocks}
    serverlessv2_scaling_configuration:
      max_capacity: 10
      min_capacity: 1
    skip_final_snapshot: true
    source: terraform-aws-modules/rds-aurora/aws
    storage_encrypted: true
    tags: ${local.tags}
    vpc_id: ${module.vpc.vpc_id}
- gen3_deployment:
    ambassador_enabled: ${var.ambassador_enabled}
    arborist_enabled: ${var.arborist_enabled}
    argo_enabled: ${var.argo_enabled}
    audit_enabled: ${var.audit_enabled}
    aurora_hostname: ${module.aurora_postgresql_v2.cluster_endpoint}
    aurora_password: ${module.aurora_postgresql_v2.cluster_master_password}
    aurora_username: postgres
    aws-es-proxy_enabled: ${var.aws-es-proxy_enabled}
    cluster_ca_cert: ${module.eks.cluster_certificate_authority_data}
    cluster_endpoint: ${module.eks.cluster_endpoint}
    cluster_name: ${module.eks.cluster_name}
    dbgap_enabled: ${var.dbgap_enabled}
    dd_enabled: ${var.dd_enabled}
    dictionary_url: ${var.dictionary_url}
    dispatcher_job_number: ${var.dispatcher_job_number}
    fence_access_key: ${var.fence_access_key}
    fence_config_path: ${var.fence_config_path}
    fence_enabled: ${var.fence_enabled}
    fence_secret_key: ${var.fence_secret_key}
    gitops_path: ${var.gitops_path}
    google_client_id: ${var.google_client_id}
    google_client_secret: ${var.google_client_secret}
    guppy_enabled: ${var.guppy_enabled}
    hatchery_enabled: ${var.hatchery_enabled}
    hostname: ${var.hostname}
    indexd_enabled: ${var.indexd_enabled}
    indexd_prefix: ${var.indexd_prefix}
    ingress_enabled: ${var.ingress_enabled}
    manifestservice_enabled: ${var.manifestservice_enabled}
    metadata_enabled: ${var.metadata_enabled}
    namespace: ${var.namespace}
    netpolicy_enabled: ${var.netpolicy_enabled}
    peregrine_enabled: ${var.peregrine_enabled}
    pidgin_enabled: ${var.pidgin_enabled}
    portal_enabled: ${var.portal_enabled}
    public_datasets: ${var.public_datasets}
    requestor_enabled: ${var.requestor_enabled}
    revproxy_arn: ${var.revproxy_arn}
    revproxy_enabled: ${var.revproxy_enabled}
    sheepdog_enabled: ${var.sheepdog_enabled}
    slack_send_dbgap: ${var.slack_send_dbgap}
    slack_webhook: ${var.slack_webhook}
    source: ../../gen3
    ssjdispatcher_enabled: ${var.ssjdispatcher_enabled}
    tier_access_level: ${var.tier_access_level}
    tier_access_limit: ${var.tier_access_limit}
    upload_bucket: ${var.upload_bucket}
    usersync_enabled: ${var.usersync_enabled}
    usersync_schedule: ${var.usersync_schedule}
    useryaml_path: ${var.useryaml_path}
    useryaml_s3_path: ${var.useryaml_s3_path}
    wts_enabled: ${var.wts_enabled}
provider:
- aws:
    profile: cdistest
    region: ${var.region}
- kubernetes:
    cluster_ca_certificate: ${base64decode(module.eks.cluster_certificate_authority_data)}
    exec:
    - api_version: client.authentication.k8s.io/v1beta1
      args:
      - eks
      - get-token
      - --cluster-name
      - ${module.eks.cluster_name}
      command: aws
    host: ${module.eks.cluster_endpoint}
- helm:
    kubernetes:
    - cluster_ca_certificate: ${base64decode(module.eks.cluster_certificate_authority_data)}
      exec:
      - api_version: client.authentication.k8s.io/v1beta1
        args:
        - eks
        - get-token
        - --cluster-name
        - ${module.eks.cluster_name}
        command: aws
      host: ${module.eks.cluster_endpoint}
- kubectl:
    apply_retry_count: 5
    cluster_ca_certificate: ${base64decode(module.eks.cluster_certificate_authority_data)}
    exec:
    - api_version: client.authentication.k8s.io/v1beta1
      args:
      - eks
      - get-token
      - --cluster-name
      - ${module.eks.cluster_name}
      command: aws
    host: ${module.eks.cluster_endpoint}
    load_config_file: false
resource:
- helm_release:
    karpenter:
      chart: karpenter
      create_namespace: true
      name: karpenter
      namespace: karpenter
      repository: oci://public.ecr.aws/karpenter
      repository_password: ${data.aws_ecrpublic_authorization_token.token.password}
      repository_username: ${data.aws_ecrpublic_authorization_token.token.user_name}
      set:
      - name: settings.aws.clusterName
        value: ${module.eks.cluster_name}
      - name: settings.aws.clusterEndpoint
        value: ${module.eks.cluster_endpoint}
      - name: serviceAccount.annotations.eks\.amazonaws\.com/role-arn
        value: ${module.karpenter.irsa_arn}
      - name: settings.aws.defaultInstanceProfile
        value: ${module.karpenter.instance_profile_name}
      - name: settings.aws.interruptionQueueName
        value: ${module.karpenter.queue_name}
      version: v0.27.0
- kubectl_manifest:
    karpenter_provisioner:
      depends_on:
      - ${helm_release.karpenter}
      yaml_body: "apiVersion: karpenter.sh/v1alpha5\nkind: Provisioner\nmetadata:\n\
        \  name: default\nspec:\n  requirements:\n    - key: karpenter.sh/capacity-type\n\
        \      operator: In\n      values: [\"spot\"]\n  limits:\n    resources:\n\
        \      cpu: 1000\n  providerRef:\n    name: default\n  ttlSecondsAfterEmpty:\
        \ 30"
- kubectl_manifest:
    karpenter_node_template:
      depends_on:
      - ${helm_release.karpenter}
      yaml_body: "apiVersion: karpenter.k8s.aws/v1alpha1\nkind: AWSNodeTemplate\n\
        metadata:\n  name: default\nspec:\n  subnetSelector:\n    karpenter.sh/discovery:\
        \ ${module.eks.cluster_name}\n  securityGroupSelector:\n    karpenter.sh/discovery:\
        \ ${module.eks.cluster_name}\n  tags:\n    karpenter.sh/discovery: ${module.eks.cluster_name}"
- kubectl_manifest:
    karpenter_example_deployment:
      depends_on:
      - ${helm_release.karpenter}
      yaml_body: "apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: inflate\n\
        spec:\n  replicas: 0\n  selector:\n    matchLabels:\n      app: inflate\n\
        \  template:\n    metadata:\n      labels:\n        app: inflate\n    spec:\n\
        \      terminationGracePeriodSeconds: 0\n      containers:\n        - name:\
        \ inflate\n          image: public.ecr.aws/eks-distro/kubernetes/pause:3.7\n\
        \          resources:\n            requests:\n              cpu: 1"
- aws_db_subnet_group:
    database:
      description: Database subnet group for ${var.vpc_name}
      name: ${var.vpc_name}-subnet-group
      subnet_ids:
      - ${module.vpc.database_subnets[0]}
      - ${module.vpc.intra_subnets[0]}
      - ${module.vpc.intra_subnets[1]}
      tags: ${local.tags}
- aws_iam_user:
    es_user:
      name: ${var.vpc_name}_es_user
      tags:
        Environment: ${var.vpc_name}
        Organization: Basic Services
- aws_iam_access_key:
    es_user_key:
      user: ${aws_iam_user.es_user.name}
- aws_cloudwatch_log_group:
    main_log_group:
      name: ${var.vpc_name}
      retention_in_days: '1827'
      tags:
        Environment: ${var.vpc_name}
        Organization: Basic Services
- random_password:
    master:
      length: 20
      special: false
- null_resource:
    kubeconfig:
      depends_on:
      - ${module.eks}
      provisioner:
      - local-exec:
          command: aws eks update-kubeconfig --name ${module.eks.cluster_name} --region
            ${var.region}
- aws_iam_role:
    aws_load_balancer_controller:
      assume_role_policy: ${data.aws_iam_policy_document.alb_ingress_controller_assume_role.json}
      name: ${var.vpc_name}-aws-load-balancer-controller
- aws_iam_role_policy_attachment:
    aws_load_balancer_controller:
      policy_arn: ${aws_iam_policy.aws_load_balancer_controller.arn}
      role: ${aws_iam_role.aws_load_balancer_controller.name}
- aws_iam_policy:
    aws_load_balancer_controller:
      description: Policy for AWS Load Balancer Controller
      name: ${var.vpc_name}-aws-load-balancer-controller-policy
      policy: ${data.aws_iam_policy_document.aws_load_balancer_controller.json}
- null_resource:
    aws_load_balancer_controller:
      depends_on:
      - ${module.eks}
      - ${aws_iam_role.aws_load_balancer_controller}
      provisioner:
      - local-exec:
          command: kubectl apply -k "github.com/aws/eks-charts/stable/aws-load-balancer-controller/crds?ref=master"
            && kubectl create sa aws-load-balancer-controller -n kube-system && kubectl
            annotate sa -n kube-system aws-load-balancer-controller eks.amazonaws.com/role-arn=${aws_iam_role.aws_load_balancer_controller.arn}
- helm_release:
    aws_load_balancer_controller:
      chart: aws-load-balancer-controller
      depends_on:
      - ${module.eks}
      - ${null_resource.aws_load_balancer_controller}
      name: aws-load-balancer-controller
      namespace: kube-system
      repository: https://aws.github.io/eks-charts
      set:
      - name: clusterName
        value: ${module.eks.cluster_name}
      - name: region
        value: ${var.region}
      - name: vpcId
        value: ${module.vpc.vpc_id}
      - name: serviceAccount.create
        value: 'false'
      - name: serviceAccount.name
        value: aws-load-balancer-controller
      version: 1.5.2
terraform:
- backend:
  - s3:
      encrypt: 'true'
      profile: cdistest
  required_providers:
  - kubectl:
      source: gavinbunney/kubectl
---
variable:
- eks_version:
    default: '1.24'
    description: value for eks version
- region:
    default: us-east-1
    description: value for region
- vpc_cidr:
    default: 10.0.0.0/16
    description: value for vpc cidr
- vpc_name:
    default: gen3test
    description: value for vpc name
- namespace:
    default: default
    description: value for namespace
- ambassador_enabled:
    default: true
    description: Enable ambassador
    type: bool
- arborist_enabled:
    default: true
    description: Enable arborist
    type: bool
- argo_enabled:
    default: true
    description: Enable argo
    type: bool
- audit_enabled:
    default: true
    description: Enable audit
    type: bool
- aws-es-proxy_enabled:
    default: true
    description: Enable aws-es-proxy
    type: bool
- dbgap_enabled:
    default: false
    description: Enable dbgap sync in the usersync job
    type: bool
- dd_enabled:
    default: false
    description: Enable datadog
    type: bool
- dictionary_url:
    default: ''
    description: URL to the data dictionary
- dispatcher_job_number:
    default: 10
    description: Number of dispatcher jobs
- fence_enabled:
    default: true
    description: Enable fence
    type: bool
- guppy_enabled:
    default: true
    description: Enable guppy
    type: bool
- hatchery_enabled:
    default: true
    description: Enable hatchery
    type: bool
- hostname:
    default: ''
    description: hostname of the commons
- indexd_enabled:
    default: true
    description: Enable indexd
    type: bool
- indexd_prefix:
    default: dg.XXXX/
    description: Indexd prefix
- ingress_enabled:
    default: true
    description: Create ALB ingress
    type: bool
- manifestservice_enabled:
    default: true
    description: Enable manfiestservice
    type: bool
- metadata_enabled:
    default: true
    description: Enable metadata
    type: bool
- netpolicy_enabled:
    default: false
    description: Enable network policy security rules
    type: bool
- peregrine_enabled:
    default: true
    description: Enable perergrine
    type: bool
- pidgin_enabled:
    default: true
    description: Enable pidgin
    type: bool
- portal_enabled:
    default: true
    description: Enable portal
    type: bool
- public_datasets:
    default: false
    description: whether the datasets are public
    type: bool
- requestor_enabled:
    default: true
    description: Enable requestor
    type: bool
- revproxy_arn:
    default: ''
    description: ARN for the revproxy cert in ACM
- revproxy_enabled:
    default: true
    description: Enable revproxy
    type: bool
- sheepdog_enabled:
    default: true
    description: Enable sheepdog
    type: bool
- slack_send_dbgap:
    default: false
    description: Enable slack message for usersync job
    type: bool
- slack_webhook:
    default: ''
    description: Slack webhook
- ssjdispatcher_enabled:
    default: true
    description: Enable ssjdispatcher
    type: bool
- tier_access_level:
    default: private
    description: Tier access level for guppy
- tier_access_limit:
    default: '100'
    description: value for tier access limit
- usersync_enabled:
    default: true
    description: Enable usersync cronjob
    type: bool
- usersync_schedule:
    default: '*/30 * * * *'
    description: Cronjob schedule for usersync
- useryaml_s3_path:
    default: https://s3.amazonaws.com/dictionary-artifacts/datadictionary/develop/schema.json
    description: S3 path to the user.yaml file
- wts_enabled:
    default: true
    description: Enable wts
    type: bool
- fence_config_path:
    default: ''
- useryaml_path:
    default: ''
- gitops_path:
    default: ''
- google_client_id:
    default: ''
- google_client_secret:
    default: ''
- fence_access_key:
    default: ''
- fence_secret_key:
    default: ''
- upload_bucket:
    default: ''
