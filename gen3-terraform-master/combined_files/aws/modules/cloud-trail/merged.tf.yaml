data:
- aws_iam_policy_document:
    trail_policy:
      statement:
      - actions:
        - logs:CreateLogStream
        - logs:PutLogEvents
        effect: Allow
        resources:
        - ${var.cloudwatchlogs_group}:*
---
resource:
- aws_cloudtrail:
    logger_trail:
      cloud_watch_logs_group_arn: ${var.cloudwatchlogs_group}:*
      cloud_watch_logs_role_arn: ${aws_iam_role.cloudtrail_to_cloudwatch_writer.arn}
      event_selector:
      - data_resource:
        - type: AWS::S3::Object
          values:
          - ${var.bucket_arn}/
        include_management_events: false
        read_write_type: All
      include_global_service_events: false
      lifecycle:
      - ignore_changes: ${all}
      name: ${var.vpc_name}-data-bucket-trail
      s3_bucket_name: ${var.bucket_id}
      s3_key_prefix: trail-logs
      tags:
        Environment: ${var.environment}
        Name: ${var.vpc_name}_data-bucket
        Purpose: trail_for_${var.vpc_name}_data_bucket
- aws_iam_role:
    cloudtrail_to_cloudwatch_writer:
      assume_role_policy: "{\n    \"Version\": \"2012-10-17\",\n    \"Statement\"\
        : [\n        {\n            \"Action\": \"sts:AssumeRole\",\n            \"\
        Principal\": {\n               \"Service\": \"cloudtrail.amazonaws.com\"\n\
        \            },\n            \"Effect\": \"Allow\",\n            \"Sid\":\
        \ \"\"\n        }\n    ]\n}"
      name: ${var.vpc_name}_data-bucket_ct_to_cwl_writer
      path: /
- aws_iam_policy:
    trail_writer:
      description: Put logs in CWL ${var.environment}
      name: trail_write_to_cwl_${var.environment}
      policy: ${data.aws_iam_policy_document.trail_policy.json}
- aws_iam_role_policy_attachment:
    trail_writer_role:
      policy_arn: ${aws_iam_policy.trail_writer.arn}
      role: ${aws_iam_role.cloudtrail_to_cloudwatch_writer.name}
---
variable:
- vpc_name: {}
- environment: {}
- cloudwatchlogs_group: {}
- bucket_arn: {}
- bucket_id: {}
