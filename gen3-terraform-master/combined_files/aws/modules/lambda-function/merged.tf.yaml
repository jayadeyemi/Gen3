data:
- archive_file:
    lambda_function:
      output_path: lambda_function_payload.zip
      source_file: ${var.lambda_function_file}
      type: zip
---
resource:
- aws_lambda_function:
    lambda_function:
      count: '${var.lambda_function_with_vpc ? 0 : 1}'
      description: ${var.lambda_function_description}
      environment:
      - variables: ${var.lambda_function_env}
      filename: ${data.archive_file.lambda_function.output_path}
      function_name: ${var.lambda_function_name}
      handler: ${var.lambda_function_handler}
      memory_size: ${var.lambda_function_memory_size}
      role: ${var.lambda_function_iam_role_arn}
      runtime: ${var.lambda_function_runtime}
      source_code_hash: ${data.archive_file.lambda_function.output_base64sha256}
      tags: ${var.lambda_function_tags}
      timeout: ${var.lambda_function_timeout}
- aws_lambda_function:
    lambda_function_with_vpc:
      count: '${var.lambda_function_with_vpc ? 1 : 0}'
      description: ${var.lambda_function_description}
      environment:
      - variables: ${var.lambda_function_env}
      filename: ${data.archive_file.lambda_function.output_path}
      function_name: ${var.lambda_function_name}
      handler: ${var.lambda_function_handler}
      memory_size: ${var.lambda_function_memory_size}
      role: ${var.lambda_function_iam_role_arn}
      runtime: ${var.lambda_function_runtime}
      source_code_hash: ${data.archive_file.lambda_function.output_base64sha256}
      tags: ${var.lambda_function_tags}
      timeout: ${var.lambda_function_timeout}
      vpc_config:
      - security_group_ids: ${var.lambda_function_security_groups}
        subnet_ids: ${var.lambda_function_subnets_id}
---
output:
- function_arn:
    value: ${aws_lambda_function.lambda_function.*.arn}
- function_name:
    value: ${aws_lambda_function.lambda_function.*.function_name}
- function_with_vpc_arn:
    value: ${aws_lambda_function.lambda_function_with_vpc.*.arn}
- function_with_vpc_name:
    value: ${aws_lambda_function.lambda_function_with_vpc.*.function_name}
---
variable:
- lambda_function_file:
    description: Path to the function file
- lambda_function_name:
    description: Name of the function you are creating
- lambda_function_description:
    default: ''
    description: Description of the function
- lambda_function_iam_role_arn:
    description: IAM role ARN to attach to the function
- lambda_function_handler:
    default: lambda_funtion.handler
    description: Function handler
- lambda_function_runtime:
    default: python3.7
    description: Language the function will use
- lambda_function_timeout:
    default: 3
    description: Timeout of the function in seconds
- lambda_function_memory_size:
    default: 128
    description: How much RAM in MB will be used
- lambda_function_env:
    default: {}
    description: Environmental variables for the funtion
- lambda_function_tags:
    default: {}
    description: Tags for the function
- lambda_function_with_vpc:
    default: false
    description: Will the function be attached to a vpc
- lambda_function_security_groups:
    default: []
    description: Security groups for the lambda function with a vpc
- lambda_function_subnets_id:
    default: []
    description: Subnets for the lambda function with a vpc
