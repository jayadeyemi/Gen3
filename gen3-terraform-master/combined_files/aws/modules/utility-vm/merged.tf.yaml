locals:
- profile_d: '#!/bin/bash

    export http{,s}_proxy=http://cloud-proxy.internal.io:3128

    export no_proxy="localhost,127.0.0.1,localaddress,169.254.169.254,.internal.io,logs.${data.aws_region.current.name}.amazonaws.com"'
  proxy_config_apt: 'Acquire::http::Proxy "http://cloud-proxy.internal.io:3128";

    Acquire::https::Proxy "http://cloud-proxy.internal.io:3128";'
  proxy_config_environment: 'http_proxy=http://cloud-proxy.internal.io:3128

    https_proxy=http://cloud-proxy.internal.io:3128

    no_proxy=localhost,127.0.0.1,localaddress,169.254.169.254,.internal.io,logs.us-east-1.amazonaws.com'
resource:
- aws_cloudwatch_log_group:
    csoc_log_group:
      name: ${var.vm_hostname}
      retention_in_days: 1827
      tags:
        Environment: ${var.environment}
        Organization: ${var.organization_name}
- aws_ami_copy:
    cdis_ami:
      description: A copy of ${data.aws_ami.public_ami.name}
      encrypted: true
      lifecycle:
      - ignore_changes:
        - ${source_ami_id}
      name: ${var.vm_name}_ami
      source_ami_id: ${data.aws_ami.public_ami.id}
      source_ami_region: ${var.aws_region}
      tags:
        Environment: ${var.environment}
        Name: cdis
- aws_security_group:
    ssh:
      description: security group that only enables ssh
      ingress:
      - cidr_blocks:
        - 0.0.0.0/0
        from_port: 22
        protocol: TCP
        to_port: 22
      name: ssh_${var.vm_name}
      tags:
        Environment: ${var.environment}
        Name: ssh_${var.vm_name}
        Organization: ${var.organization_name}
      vpc_id: ${var.vpc_id}
- aws_security_group:
    local:
      description: security group that only allow internal tcp traffics
      egress:
      - cidr_blocks: ${var.vpc_cidr_list}
        from_port: 0
        protocol: '-1'
        to_port: 0
      ingress:
      - cidr_blocks:
        - 10.128.0.0/20
        from_port: 0
        protocol: '-1'
        to_port: 0
      name: local_${var.vm_name}
      tags:
        Environment: ${var.environment}
        Name: local_${var.vm_name}
        Organization: ${var.organization_name}
      vpc_id: ${var.vpc_id}
- aws_iam_role:
    vm_role:
      assume_role_policy: "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n\
        \    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n  \
        \      \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Effect\": \"\
        Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}"
      name: ${var.vm_name}_role
      path: /
      tags:
        Environment: ${var.environment}
        Name: local_${var.vm_name}
        Organization: ${var.organization_name}
- aws_iam_role_policy:
    vm_policy:
      name: ${var.vm_name}_policy
      policy: ${data.aws_iam_policy_document.vm_policy_document.json}
      role: ${aws_iam_role.vm_role.id}
- aws_iam_role_policy:
    vm_user_policy:
      name: ${var.vm_name}_user_policy
      policy: ${var.user_policy}
      role: ${aws_iam_role.vm_role.id}
- aws_iam_instance_profile:
    vm_role_profile:
      name: ${var.vm_name}_role_profile
      role: ${aws_iam_role.vm_role.id}
- aws_instance:
    utility_vm:
      ami: ${aws_ami_copy.cdis_ami.id}
      iam_instance_profile: ${aws_iam_instance_profile.vm_role_profile.name}
      instance_type: ${var.instance_type}
      key_name: ${var.ssh_key_name}
      lifecycle:
      - ignore_changes:
        - ${ami}
        - ${key_name}
      monitoring: true
      provisioner:
      - file:
          connection:
          - host: ${self.private_ip}
            type: ssh
            user: ubuntu
          content: '${var.proxy ? local.proxy_config_apt : ""}'
          destination: /tmp/01proxy
      - file:
          connection:
          - host: ${self.private_ip}
            type: ssh
            user: ubuntu
          content: '${var.proxy ? local.profile_d : ""}'
          destination: /tmp/99-proxy.sh
      subnet_id: ${var.vpc_subnet_id}
      tags:
        Environment: ${var.environment}
        Name: ${var.vm_name}
        Organization: ${var.organization_name}
      user_data: "#!/bin/bash \n\ncat /tmp/01proxy | tee -a /etc/apt/apt.conf.d/01proxy\n\
        cat /tmp/99-proxy.sh | tee /etc/profile.d/99-proxy.sh\nchmod +x /etc/profile.d/99-proxy.sh\n\
        \nUSER=\"ubuntu\"\nUSER_HOME=\"/home/$USER\"\nCLOUD_AUTOMATION=\"$USER_HOME/cloud-automation\"\
        \n(\n  source /etc/profile.d/99-proxy.sh\n  cd $USER_HOME\n  git clone https://github.com/uc-cdis/cloud-automation.git\n\
        \  cd $CLOUD_AUTOMATION\n  git pull\n  cat $CLOUD_AUTOMATION/${var.authorized_keys}\
        \ | sudo tee --append $USER_HOME/.ssh/authorized_keys\n\n  # This is needed\
        \ temporarily for testing purposes ; before merging the code to master\n \
        \ if [ \"${var.branch}\" != \"master\" ];\n  then\n    git checkout \"${var.branch}\"\
        \n    git pull\n  fi\n  chown -R ubuntu. $CLOUD_AUTOMATION\n\n  echo \"127.0.1.1\
        \ ${var.vm_hostname}\" | tee --append /etc/hosts\n  hostnamectl set-hostname\
        \ ${var.vm_hostname}\n\n  apt -y update\n  DEBIAN_FRONTEND='noninteractive'\
        \ apt-get -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold'\
        \ upgrade\n\n  apt autoremove -y\n  apt clean\n  apt autoclean\n\n  cd $USER_HOME\n\
        \n  bash \"${var.bootstrap_path}${var.bootstrap_script}\" \"cwl_group=${aws_cloudwatch_log_group.csoc_log_group.name};vm_role=${aws_iam_role.vm_role.name};account_id=${var.aws_account_id};${join(\"\
        ;\",var.extra_vars)}\" 2>&1\n  cd $CLOUD_AUTOMATION\n  git checkout master\n\
        ) > /var/log/bootstrapping_script.log\n\n# Install qualys agent if the activtion\
        \ and customer id provided\nif [[ ! -z \"${var.activation_id}\" ]] || [[ !\
        \ -z \"${var.customer_id}\" ]]; then\n    aws s3 cp s3://qualys-agentpackage/QualysCloudAgent.rpm\
        \ ./qualys-cloud-agent.x86_64.rpm\n    sudo rpm -ivh qualys-cloud-agent.x86_64.rpm\n\
        \    # Clean up rpm package after install\n    rm qualys-cloud-agent.x86_64.rpm\n\
        \    sudo /usr/local/qualys/cloud-agent/bin/qualys-cloud-agent.sh ActivationId=${var.activation_id}\
        \ CustomerId=${var.customer_id}\nfi"
      vpc_security_group_ids:
      - ${aws_security_group.ssh.id}
      - ${aws_security_group.local.id}
---
data:
- aws_ami:
    public_ami:
      filter:
      - name: name
        values:
        - ${var.image_name_search_criteria}
      - name: virtualization-type
        values:
        - hvm
      - name: root-device-type
        values:
        - ebs
      most_recent: true
      owners:
      - ${var.ami_account_id}
- aws_iam_policy_document:
    vm_policy_document:
      statement:
      - actions:
        - logs:CreateLogGroup
        - logs:CreateLogStream
        - logs:GetLogEvents
        - logs:PutLogEvents
        - logs:DescribeLogGroups
        - logs:DescribeLogStreams
        - logs:PutRetentionPolicy
        effect: Allow
        resources:
        - '*'
- aws_region:
    current: {}
---
output:
- utility_private_ip:
    value: ${aws_instance.utility_vm.private_ip}
- role_id:
    value: ${aws_iam_role.vm_role.name}
---
variable:
- ami_account_id:
    default: 099720109477
    description: AWS account id of who owns the AMI
- aws_account_id:
    default: '433568766270'
    description: AWS account id where the VM is going to be deployed
- aws_region:
    default: us-east-1
    description: AWS region where the VM will be deployed
- vpc_id:
    default: vpc-e2b51d99
    description: VPC id where the VM will live
- vpc_subnet_id:
    default: subnet-6127013c
    description: Subnet id where the VM will live
- vpc_cidr_list:
    default:
    - 10.128.0.0/20
    - 54.0.0.0/8
    - 52.0.0.0/8
    description: CIDRs that will skip the proxy
    type: ${list(string)}
- ssh_key_name:
    description: SSH key required to deploy the VM
- environment:
    default: CSOC
    description: For tagging purposes
- instance_type:
    default: t3.micro
    description: Instance type to be deploy the VM on
- image_name_search_criteria:
    default: ubuntu/images/hvm-ssd/ubuntu-bionic-18.04-amd64-server-*
    description: Searc criteria for the AMI
- extra_vars:
    description: List of variables that terraform will send to the bootstrapscript
    type: ${list(string)}
- bootstrap_path:
    description: Path where the bootstrap script it'll run after user_data portion
      is complete
- bootstrap_script:
    description: The actual bootstrap script
- vm_name:
    description: Name for the VM
- vm_hostname:
    description: Hostname for the VM
- proxy:
    default: true
    description: if the VM is going to be behind a proxy
- authorized_keys:
    default: files/authorized_keys/ops_team
    description: Before the bootstrap script kicks in, the authorized_keys file for
      ubuntu will be updated with this file
- organization_name:
    default: Basic Service
    description: For tagging purposes
- branch:
    default: master
    description: For testing purposes
- user_policy:
    default: "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n     \
      \ \"Action\": [\n        \"logs:PutLogEvents\"\n      ],\n      \"Effect\":\
      \ \"Allow\",\n      \"Resource\": [\"*\"],\n      \"Sid\": \"\"\n    }\n  ]\n\
      }"
- activation_id:
    default: ''
- customer_id:
    default: ''
