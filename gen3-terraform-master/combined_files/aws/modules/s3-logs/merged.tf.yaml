resource:
- aws_s3_bucket:
    log_bucket:
      bucket: ${local.clean_bucket_name}
      tags:
        Environment: ${var.environment}
        Name: ${local.clean_bucket_name}
        Purpose: logs bucket
- aws_s3_bucket_server_side_encryption_configuration:
    log_bucket:
      bucket: ${aws_s3_bucket.log_bucket.bucket}
      rule:
      - apply_server_side_encryption_by_default:
        - sse_algorithm: AES256
- aws_s3_bucket_lifecycle_configuration:
    log_bucket:
      bucket: ${aws_s3_bucket.log_bucket.id}
      rule:
      - expiration:
        - days: 1825
        filter:
        - and:
          - prefix: /
            tags:
              autoclean: 'true'
              rule: log
        id: log
        status: Enabled
- aws_s3_bucket_public_access_block:
    s3-log_bucket_privacy:
      block_public_acls: true
      block_public_policy: true
      bucket: ${aws_s3_bucket.log_bucket.id}
      ignore_public_acls: true
      restrict_public_buckets: true
- aws_iam_policy:
    log_bucket_writer:
      description: Read or write ${local.clean_bucket_name}
      name: bucket_writer_${local.clean_bucket_name}
      policy: ${data.aws_iam_policy_document.log_bucket_writer.json}
- aws_s3_bucket_policy:
    log_bucket_writer_by_ct:
      bucket: ${aws_s3_bucket.log_bucket.id}
      policy: "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n    \
        \  \"Sid\": \"AWSCloudTrailAclCheck20150319\",\n      \"Effect\": \"Allow\"\
        ,\n      \"Principal\": {\n         \"Service\": \"cloudtrail.amazonaws.com\"\
        \n      },\n      \"Action\": \"s3:GetBucketAcl\",\n      \"Resource\": \"\
        ${aws_s3_bucket.log_bucket.arn}\"\n    },\n    {\n      \"Sid\": \"AWSCloudTrailWrite20150319\"\
        ,\n     \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\"\
        : \"cloudtrail.amazonaws.com\"\n      },\n      \"Action\": \"s3:PutObject\"\
        ,\n      \"Resource\": \"${aws_s3_bucket.log_bucket.arn}/*\",\n      \"Condition\"\
        : {\n         \"StringEquals\": {\n         \"s3:x-amz-acl\": \"bucket-owner-full-control\"\
        \n         }\n      }\n    }\n  ]\n}"
---
data:
- aws_iam_policy_document:
    log_bucket_writer:
      statement:
      - actions:
        - s3:Get*
        - s3:List*
        effect: Allow
        resources:
        - ${aws_s3_bucket.log_bucket.arn}
        - ${aws_s3_bucket.log_bucket.arn}/*
      - actions:
        - s3:PutObject
        - s3:GetObject
        - s3:DeleteObject
        effect: Allow
        resources:
        - ${aws_s3_bucket.log_bucket.arn}/*
---
output:
- log_bucket_name:
    value: ${aws_s3_bucket.log_bucket.id}
- rw_policy_arn:
    value: ${aws_iam_policy.log_bucket_writer.arn}
---
locals:
- clean_bucket_name: ${replace(replace(var.log_bucket_name, "_", "-"), ".", "-")}
variable:
- log_bucket_name: {}
- environment: {}
