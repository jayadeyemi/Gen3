data:
- aws_caller_identity:
    current: {}
- aws_region:
    current: {}
- aws_iam_policy_document:
    enhanced_monitoring:
      statement:
      - actions:
        - sts:AssumeRole
        principals:
        - identifiers:
          - monitoring.rds.amazonaws.com
          type: Service
- aws_iam_policy_document:
    backup_bucket_access_kms:
      statement:
      - actions:
        - kms:DescribeKey
        - kms:GenerateDataKey
        - kms:Encrypt
        - kms:Decrypt
        effect: Allow
        resources:
        - arn:aws:kms:${data.aws_region.current.name}:${data.aws_caller_identity.current.account_id}:key/${var.rds_instance_backup_kms_key}
      - actions:
        - s3:ListBucket
        - s3:GetBucketLocation
        effect: Allow
        resources:
        - arn:aws:s3:::${var.rds_instance_backup_bucket_name}
      - actions:
        - s3:GetObject
        - s3:PutObject
        - s3:ListMultipartUploadParts
        - s3:AbortMultipartUpload
        effect: Allow
        resources:
        - arn:aws:s3:::${var.rds_instance_backup_bucket_name}/*
---
locals:
- is_mssql: '${element(split("-", var.rds_instance_engine), 0) == "sqlserver" ? True
    : False}'
resource:
- aws_iam_role:
    enhanced_monitoring:
      assume_role_policy: ${data.aws_iam_policy_document.enhanced_monitoring.json}
      count: '${var.rds_instance_create_monitoring_role ? 1 : 0}'
      name: ${var.rds_instance_monitoring_role_name}
      tags: '${merge(tomap({"Name": "${var.rds_instance_monitoring_role_name}"}),
        var.rds_instance_tags)}'
- aws_iam_role_policy_attachment:
    enhanced_monitoring:
      count: '${var.rds_instance_create_monitoring_role ? 1 : 0}'
      policy_arn: arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole
      role: ${aws_iam_role.enhanced_monitoring.*.name[count.index]}
- random_string:
    randommssql:
      count: '${var.rds_instance_create && local.is_mssql ? 1 : 0}'
      length: 16
      special: false
- random_string:
    randomother:
      count: '${var.rds_instance_create && false == local.is_mssql ? 1 : 0}'
      length: 16
      special: true
- aws_db_option_group:
    rds_instance_new_option_group:
      engine_name: ${var.rds_instance_engine}
      major_engine_version: '${local.is_mssql ? substr(var.rds_instance_engine_version,
        0, 5) : var.rds_instance_engine_version}'
      name: ${var.rds_instance_identifier}-option-group
      option:
      - option_name: SQLSERVER_BACKUP_RESTORE
        option_settings:
        - name: IAM_ROLE_ARN
          value: ${aws_iam_role.rds_backup_role.arn}
      option_group_description: Additional options to the database
      tags: '${merge(tomap({"Name": "${var.rds_instance_monitoring_role_name}"}),
        var.rds_instance_tags)}'
- aws_iam_role:
    rds_backup_role:
      assume_role_policy: "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n\
        \    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\"\
        : \"rds.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n\
        \    }\n  ]\n}"
      name: ${var.rds_instance_identifier}-backup-role
      tags: '${merge(tomap({"Name": "${var.rds_instance_monitoring_role_name}"}),
        var.rds_instance_tags)}'
- aws_iam_role_policy:
    backup_bucket_access:
      name: ${var.rds_instance_identifier}_backup_bucket_access
      policy: ${data.aws_iam_policy_document.backup_bucket_access_kms.json}
      role: ${aws_iam_role.rds_backup_role.id}
- aws_db_instance:
    this:
      allocated_storage: ${var.rds_instance_allocated_storage}
      allow_major_version_upgrade: ${var.rds_instance_allow_major_version_upgrade}
      apply_immediately: ${var.rds_instance_apply_immediately}
      auto_minor_version_upgrade: ${var.rds_instance_auto_minor_version_upgrade}
      availability_zone: ${var.rds_instance_availability_zone}
      backup_retention_period: ${var.rds_instance_backup_retention_period}
      backup_window: ${var.rds_instance_backup_window}
      character_set_name: ${var.rds_instance_character_set_name}
      copy_tags_to_snapshot: ${var.rds_instance_copy_tags_to_snapshot}
      count: '${var.rds_instance_create && false == local.is_mssql ? 1 : 0}'
      db_name: ${var.rds_instance_name}
      db_subnet_group_name: ${var.rds_instance_db_subnet_group_name}
      deletion_protection: ${var.rds_instance_deletion_protection}
      enabled_cloudwatch_logs_exports: ${var.rds_instance_enabled_cloudwatch_logs_exports}
      engine: ${var.rds_instance_engine}
      engine_version: ${var.rds_instance_engine_version}
      final_snapshot_identifier: ${var.rds_instance_final_snapshot_identifier}
      iam_database_authentication_enabled: ${var.rds_instance_iam_database_authentication_enabled}
      identifier: ${var.rds_instance_identifier}
      instance_class: ${var.rds_instance_instance_class}
      iops: ${var.rds_instance_iops}
      kms_key_id: ${var.rds_instance_kms_key_id}
      license_model: ${var.rds_instance_license_model}
      maintenance_window: ${var.rds_instance_maintenance_window}
      max_allocated_storage: ${var.rds_instance_max_allocated_storage}
      monitoring_interval: ${var.rds_instance_monitoring_interval}
      monitoring_role_arn: '${var.rds_instance_monitoring_interval == 0 ? "" : coalesce(var.rds_instance_monitoring_role_arn,
        join("", aws_iam_role.enhanced_monitoring.*.arn))}'
      multi_az: ${var.rds_instance_multi_az}
      option_group_name: '${var.rds_instance_option_group_name == "" && var.rds_instance_backup_enabled
        ? aws_db_option_group.rds_instance_new_option_group.name : var.rds_instance_option_group_name}'
      parameter_group_name: ${var.rds_instance_parameter_group_name}
      password: '${var.rds_instance_password == "" ? random_string.randomother.*.result[count.index]
        : var.rds_instance_password}'
      performance_insights_enabled: ${var.rds_instance_performance_insights_enabled}
      performance_insights_retention_period: '${var.rds_instance_performance_insights_enabled
        == True ? var.rds_instance_performance_insights_retention_period : 0}'
      port: ${var.rds_instance_port}
      publicly_accessible: ${var.rds_instance_publicly_accessible}
      skip_final_snapshot: ${var.rds_instance_skip_final_snapshot}
      snapshot_identifier: ${var.rds_instance_snapshot_identifier}
      storage_encrypted: ${var.rds_instance_storage_encrypted}
      storage_type: ${var.rds_instance_storage_type}
      tags: '${merge(tomap({"Name": "${var.rds_instance_identifier}"}), var.rds_instance_tags)}'
      timeouts:
      - create: ${lookup(var.rds_instance_timeouts, "create", "")}
        delete: ${lookup(var.rds_instance_timeouts, "delete", "")}
        update: ${lookup(var.rds_instance_timeouts, "update", "")}
      username: ${var.rds_instance_username}
      vpc_security_group_ids: ${var.rds_instance_vpc_security_group_ids}
- aws_db_instance:
    this_mssql:
      allocated_storage: ${var.rds_instance_allocated_storage}
      allow_major_version_upgrade: ${var.rds_instance_allow_major_version_upgrade}
      apply_immediately: ${var.rds_instance_apply_immediately}
      auto_minor_version_upgrade: ${var.rds_instance_auto_minor_version_upgrade}
      availability_zone: ${var.rds_instance_availability_zone}
      backup_retention_period: ${var.rds_instance_backup_retention_period}
      backup_window: ${var.rds_instance_backup_window}
      copy_tags_to_snapshot: ${var.rds_instance_copy_tags_to_snapshot}
      count: '${var.rds_instance_create && local.is_mssql ? 1 : 0}'
      db_name: ${var.rds_instance_name}
      db_subnet_group_name: ${var.rds_instance_db_subnet_group_name}
      deletion_protection: ${var.rds_instance_deletion_protection}
      enabled_cloudwatch_logs_exports: ${var.rds_instance_enabled_cloudwatch_logs_exports}
      engine: ${var.rds_instance_engine}
      engine_version: ${var.rds_instance_engine_version}
      final_snapshot_identifier: ${var.rds_instance_final_snapshot_identifier}
      iam_database_authentication_enabled: ${var.rds_instance_iam_database_authentication_enabled}
      identifier: ${var.rds_instance_identifier}
      instance_class: ${var.rds_instance_instance_class}
      iops: ${var.rds_instance_iops}
      kms_key_id: ${var.rds_instance_kms_key_id}
      license_model: ${var.rds_instance_license_model}
      maintenance_window: ${var.rds_instance_maintenance_window}
      max_allocated_storage: ${var.rds_instance_max_allocated_storage}
      monitoring_interval: ${var.rds_instance_monitoring_interval}
      monitoring_role_arn: '${var.rds_instance_monitoring_interval == 0 ? "" : coalesce(var.rds_instance_monitoring_role_arn,
        join("", aws_iam_role.enhanced_monitoring.*.arn))}'
      multi_az: ${var.rds_instance_multi_az}
      option_group_name: '${var.rds_instance_option_group_name == "" && var.rds_instance_backup_enabled
        ? aws_db_option_group.rds_instance_new_option_group.name : var.rds_instance_option_group_name}'
      parameter_group_name: ${var.rds_instance_parameter_group_name}
      password: '${var.rds_instance_password == "" ? random_string.randommssql.*.result[count.index]
        : var.rds_instance_password}'
      performance_insights_enabled: ${var.rds_instance_performance_insights_enabled}
      performance_insights_retention_period: '${var.rds_instance_performance_insights_enabled
        == True ? var.rds_instance_performance_insights_retention_period : 0}'
      port: ${var.rds_instance_port}
      publicly_accessible: ${var.rds_instance_publicly_accessible}
      skip_final_snapshot: ${var.rds_instance_skip_final_snapshot}
      snapshot_identifier: ${var.rds_instance_snapshot_identifier}
      storage_encrypted: ${var.rds_instance_storage_encrypted}
      storage_type: ${var.rds_instance_storage_type}
      tags: '${merge(tomap({"Name": "${var.rds_instance_identifier}"}), var.rds_instance_tags)}'
      timeouts:
      - create: ${lookup(var.rds_instance_timeouts, "create", "")}
        delete: ${lookup(var.rds_instance_timeouts, "delete", "")}
        update: ${lookup(var.rds_instance_timeouts, "update", "")}
      timezone: ${var.rds_instance_timezone}
      username: ${var.rds_instance_username}
      vpc_security_group_ids: ${var.rds_instance_vpc_security_group_ids}
---
locals:
- this_db_instance_address: ${element(concat(aws_db_instance.this_mssql.*.address,
    aws_db_instance.this.*.address), 0)}
  this_db_instance_arn: ${element(concat(aws_db_instance.this_mssql.*.arn, aws_db_instance.this.*.arn),
    0)}
  this_db_instance_availability_zone: ${element(concat(aws_db_instance.this_mssql.*.availability_zone,
    aws_db_instance.this.*.availability_zone), 0)}
  this_db_instance_endpoint: ${element(concat(aws_db_instance.this_mssql.*.endpoint,
    aws_db_instance.this.*.endpoint), 0)}
  this_db_instance_hosted_zone_id: ${element(concat(aws_db_instance.this_mssql.*.hosted_zone_id,
    aws_db_instance.this.*.hosted_zone_id), 0)}
  this_db_instance_id: ${element(concat(aws_db_instance.this_mssql.*.id, aws_db_instance.this.*.identifier),
    0)}
  this_db_instance_name: ${element(concat(aws_db_instance.this_mssql.*.db_name, aws_db_instance.this.*.db_name),
    0)}
  this_db_instance_password: ${element(concat(aws_db_instance.this_mssql.*.password,
    aws_db_instance.this.*.password), 0)}
  this_db_instance_port: ${element(concat(aws_db_instance.this_mssql.*.port, aws_db_instance.this.*.port),
    0)}
  this_db_instance_resource_id: ${element(concat(aws_db_instance.this_mssql.*.resource_id,
    aws_db_instance.this.*.resource_id), 0)}
  this_db_instance_status: ${element(concat(aws_db_instance.this_mssql.*.status, aws_db_instance.this.*.status),
    0)}
  this_db_instance_username: ${element(concat(aws_db_instance.this_mssql.*.username,
    aws_db_instance.this.*.username), 0)}
output:
- rds_instance_password:
    description: The password for the user for the database
    sensitive: true
    value: ${local.this_db_instance_password}
- rds_instance_address:
    description: The address of the RDS instance
    value: ${local.this_db_instance_address}
- rds_instance_arn:
    description: The ARN of the RDS instance
    value: ${local.this_db_instance_arn}
- rds_instance_availability_zone:
    description: The availability zone of the RDS instance
    value: ${local.this_db_instance_availability_zone}
- rds_instance_endpoint:
    description: The connection endpoint
    value: ${local.this_db_instance_endpoint}
- rds_instance_hosted_zone_id:
    description: The canonical hosted zone ID of the DB instance (to be used in a
      Route 53 Alias record)
    value: ${local.this_db_instance_hosted_zone_id}
- rds_instance_id:
    description: The RDS instance ID
    value: ${local.this_db_instance_id}
- rds_instance_resource_id:
    description: The RDS Resource ID of this instance
    value: ${local.this_db_instance_resource_id}
- rds_instance_status:
    description: The RDS instance status
    value: ${local.this_db_instance_status}
- rds_instance_name:
    description: The database name
    value: ${local.this_db_instance_name}
- rds_instance_username:
    description: The master username for the database
    value: ${local.this_db_instance_username}
- rds_instance_port:
    description: The database port
    value: ${local.this_db_instance_port}
---
variable:
- rds_instance_create:
    default: true
    description: Whether to create this resource or not?
- rds_instance_allocated_storage:
    description: The allocated storage in gibibytes
- rds_instance_storage_type:
    default: gp2
    description: gp2, io1, standard
- rds_instance_engine:
    description: The database engine to use
- rds_instance_engine_version:
    description: The engine version to use. If auto_minor_version_upgrade is enabled,
      you can provide a prefix of the version such as 5.7 (for 5.7.10) and this attribute
      will ignore differences in the patch version automatically (e.g. 5.7.17)
- rds_instance_instance_class:
    default: db.t2.micro
    description: The instance type of the RDS instance
- rds_instance_name:
    default: ''
    description: Name for the database to be created
- rds_instance_identifier:
    description: The name of the RDS instance, if omitted, Terraform will assign a
      random, unique identifier
- rds_instance_username:
    description: Username to use
- rds_instance_password:
    default: ''
    description: Password to use
- rds_instance_parameter_group_name:
    default: ''
    description: Name of the DB parameter group to associate
- rds_instance_allow_major_version_upgrade:
    default: true
    description: Indicates that major version upgrades are allowed
- rds_instance_apply_immediately:
    default: false
    description: Specifies whether any database modifications are applied immediately,
      or during the next maintenance window
- rds_instance_auto_minor_version_upgrade:
    default: true
    description: Indicates that minor engine upgrades will be applied automatically
      to the DB instance during the maintenance window
- rds_instance_backup_retention_period:
    default: 0
    description: The days to retain backups for. Must be between 0 and 35
- rds_instance_backup_window:
    default: 03:46-04:16
    description: 'The daily time range (in UTC) during which automated backups are
      created if they are enabled. Example: ''09:46-10:16''. Must not overlap with
      maintenance_window'
- rds_instance_db_subnet_group_name:
    description: Name of DB subnet group. DB instance will be created in the VPC associated
      with the DB subnet group
- rds_instance_maintenance_window:
    default: Mon:00:00-Mon:03:00
    description: The window to perform maintenance in
- rds_instance_multi_az:
    default: false
    description: Specifies if the RDS instance is multi-AZ
- rds_instance_option_group_name:
    default: ''
    description: Name of the DB option group to associate
- rds_instance_publicly_accessible:
    default: false
    description: Bool to control if instance is publicly accessible
- rds_instance_skip_final_snapshot:
    default: false
    description: rds_instance_skip_final_snapshot
- rds_instance_storage_encrypted:
    default: false
    description: Specifies whether the DB instance is encrypted
- rds_instance_vpc_security_group_ids:
    default: []
    description: List of VPC security groups to associate
    type: ${list(string)}
- rds_instance_tags:
    default: {}
    description: Tags for the instance
- rds_instance_port:
    description: The port on which the DB accepts connections
- rds_instance_license_model:
    default: ''
    description: License model information for this DB instance
- rds_instance_performance_insights_enabled:
    default: false
    description: Specifies whether Performance Insights are enabled
- rds_instance_performance_insights_retention_period:
    default: 7
    description: The amount of time in days to retain Performance Insights data. Either
      7 (7 days) or 731 (2 years).
- rds_instance_timeouts:
    default:
      create: 40m
      delete: 40m
      update: 80m
    description: (Optional) Updated Terraform resource management timeouts. Applies
      to `aws_db_instance` in particular to permit resource management times
- rds_instance_monitoring_role_name:
    default: rds-monitoring-role
    description: Name of the IAM role which will be created when create_monitoring_role
      is enabled.
- rds_instance_max_allocated_storage:
    default: 0
    description: Specifies the value for Storage Autoscaling
- rds_instance_availability_zone:
    default: ''
    description: The Availability Zone of the RDS instance
- rds_instance_final_snapshot_identifier:
    default: false
    description: The name of your final DB snapshot when this DB instance is deleted.
- rds_instance_monitoring_role_arn:
    default: ''
    description: The ARN for the IAM role that permits RDS to send enhanced monitoring
      metrics to CloudWatch Logs. Must be specified if monitoring_interval is non-zero.
- rds_instance_copy_tags_to_snapshot:
    default: false
    description: On delete, copy all Instance tags to the final snapshot (if final_snapshot_identifier
      is specified)
- rds_instance_kms_key_id:
    default: ''
    description: The ARN for the KMS encryption key. If creating an encrypted replica,
      set this to the destination KMS ARN. If storage_encrypted is set to true and
      kms_key_id is not specified the default KMS key created in your account will
      be used
- rds_instance_enabled_cloudwatch_logs_exports:
    default: []
    description: 'List of log types to enable for exporting to CloudWatch logs. If
      omitted, no logs will be exported. Valid values (depending on engine): alert,
      audit, error, general, listener, slowquery, trace, postgresql (PostgreSQL),
      upgrade (PostgreSQL).'
- rds_instance_iops:
    default: 0
    description: The amount of provisioned IOPS. Setting this implies a storage_type
      of 'io1'
- rds_instance_throughput:
    default: 0
    description: The amount of provisioned throughput.
- rds_instance_deletion_protection:
    default: false
    description: The database can't be deleted when this value is set to true.
- rds_instance_iam_database_authentication_enabled:
    default: false
    description: Specifies whether or mappings of AWS Identity and Access Management
      (IAM) accounts to database accounts is enabled
- rds_instance_timezone:
    default: ''
    description: (Optional) Time zone of the DB instance. timezone is currently only
      supported by Microsoft SQL Server. The timezone can only be set on creation.
      See MSSQL User Guide for more information.
- rds_instance_monitoring_interval:
    default: 0
    description: 'The interval, in seconds, between points when Enhanced Monitoring
      metrics are collected for the DB instance. To disable collecting Enhanced Monitoring
      metrics, specify 0. The default is 0. Valid Values: 0, 1, 5, 10, 15, 30, 60.'
- rds_instance_snapshot_identifier:
    default: ''
    description: 'Specifies whether or not to create this database from a snapshot.
      This correlates to the snapshot ID you''d find in the RDS console, e.g: rds:production-2015-06-26-06-05.'
- rds_instance_replicate_source_db:
    default: ''
    description: Specifies that this resource is a Replicate database, and to use
      this value as the source database. This correlates to the identifier of another
      Amazon RDS Database to replicate.
- rds_instance_create_monitoring_role:
    default: false
    description: Create IAM role with a defined name that permits RDS to send enhanced
      monitoring metrics to CloudWatch Logs.
- rds_instance_character_set_name:
    default: ''
    description: (Optional) The character set name to use for DB encoding in Oracle
      instances. This can't be changed. See Oracle Character Sets Supported in Amazon
      RDS for more information
- rds_instance_backup_enabled:
    default: false
    description: To enable backups onto S3
- rds_instance_backup_kms_key:
    default: ''
    description: KMS to enable backups onto S3
- rds_instance_backup_bucket_name:
    default: ''
    description: The bucket to send bacups to
