data:
- aws_rds_cluster:
    source_db_instance:
      cluster_identifier: ${var.db_instance_identifier}
---
output:
- identifier:
    value: ${aws_rds_cluster_instance.postgresql.identifier}
- cluster_identifier:
    value: ${aws_rds_cluster.postgresql.cluster_identifier}
---
locals:
- master_password: '${var.master_password != "" ? var.master_password : random_password.password.result}'
  snapshot_date: ${formatdate("MM-DD-YYYY", timestamp())}
  snapshot_identifier: ${var.vpc_name}-${var.cluster_instance_identifier}-reencrypt-${local.snapshot_date}
resource:
- random_password:
    password:
      length: ${var.password_length}
      special: false
- aws_rds_cluster:
    postgresql:
      apply_immediately: true
      backup_retention_period: ${data.aws_rds_cluster.source_db_instance.backup_retention_period}
      cluster_identifier: ${var.vpc_name}-${var.cluster_identifier}-new
      db_cluster_parameter_group_name: ${data.aws_rds_cluster.source_db_instance.db_cluster_parameter_group_name}
      db_subnet_group_name: ${data.aws_rds_cluster.source_db_instance.db_subnet_group_name}
      engine: ${data.aws_rds_cluster.source_db_instance.engine}
      engine_mode: ${var.engine_mode}
      engine_version: ${data.aws_rds_cluster.source_db_instance.engine_version}
      final_snapshot_identifier: ${var.vpc_name}-${var.cluster_instance_identifier}-new-snapshot-${local.snapshot_date}
      kms_key_id: ${var.db_kms_key_id}
      lifecycle:
      - ignore_changes: ${all}
      master_password: ${local.master_password}
      master_username: ${var.master_username}
      preferred_backup_window: ${data.aws_rds_cluster.source_db_instance.preferred_backup_window}
      serverlessv2_scaling_configuration:
      - max_capacity: ${var.serverlessv2_scaling_max_capacity}
        min_capacity: ${var.serverlessv2_scaling_min_capacity}
      skip_final_snapshot: false
      snapshot_identifier: ${aws_db_cluster_snapshot.db_snapshot.id}
      storage_encrypted: true
      vpc_security_group_ids: ${data.aws_rds_cluster.source_db_instance.vpc_security_group_ids[*]}
- aws_rds_cluster_instance:
    postgresql:
      cluster_identifier: ${aws_rds_cluster.postgresql.cluster_identifier}
      db_subnet_group_name: ${aws_rds_cluster.postgresql.db_subnet_group_name}
      engine: ${data.aws_rds_cluster.source_db_instance.engine}
      engine_version: ${data.aws_rds_cluster.source_db_instance.engine_version}
      identifier: ${var.vpc_name}-${var.cluster_instance_identifier}-new
      instance_class: ${var.instance_class}
      lifecycle:
      - ignore_changes: ${all}
- aws_db_cluster_snapshot:
    db_snapshot:
      db_cluster_identifier: ${data.aws_rds_cluster.source_db_instance.id}
      db_cluster_snapshot_identifier: ${local.snapshot_identifier}
      lifecycle:
      - ignore_changes: ${all}
terraform:
- backend:
  - s3:
      encrypt: 'true'
---
variable:
- vpc_name: {}
- db_instance_identifier:
    default: ''
- db_kms_key_id:
    default: ''
- cluster_identifier:
    default: aurora-cluster
    description: Cluster Identifier
    type: string
- cluster_instance_identifier:
    default: aurora-cluster-instance
    description: Cluster Instance Identifier
    type: string
- serverlessv2_scaling_min_capacity:
    default: '0.5'
    description: Serverless v2 RDS cluster minimum scaling capacity in ACUs
    type: string
- serverlessv2_scaling_max_capacity:
    default: '10.0'
    description: Serverless v2 RDS cluster maximum scaling capacity in ACUs
    type: string
- master_username:
    default: postgres
    description: Master DB username
    type: string
- master_password:
    default: ''
    description: Master DB password
    type: string
- storage_encrypted:
    default: true
    description: Specifies whether storage encryption is enabled
    type: bool
- engine_mode:
    default: provisioned
    description: use provisioned for Serverless v2 RDS cluster
    type: string
- password_length:
    default: 12
    description: The length of the password string
    type: number
- instance_class:
    default: db.serverless
    description: Cluster Instance Class
    type: string
