resource:
- aws_s3_bucket:
    sftp_bucket:
      bucket: ${var.s3_bucket_name}
- aws_s3_bucket_server_side_encryption_configuration:
    sftp_bucket:
      bucket: ${aws_s3_bucket.sftp_bucket.id}
      rule:
      - apply_server_side_encryption_by_default:
        - sse_algorithm: AES256
- aws_iam_role:
    sftp_role:
      assume_role_policy: "{\n    \"Version\": \"2012-10-17\",\n    \"Statement\"\
        : [\n        {\n        \"Effect\": \"Allow\",\n        \"Principal\": {\n\
        \            \"Service\": \"transfer.amazonaws.com\"\n        },\n       \
        \ \"Action\": \"sts:AssumeRole\"\n        }\n    ]\n}"
      name: sftp_role
- aws_iam_role_policy:
    sftp:
      name: sftp_policy
      policy: "{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n       \
        \ {\n            \"Sid\": \"VisualEditor0\",\n            \"Effect\": \"Allow\"\
        ,\n            \"Action\": [\n                \"s3:Put*\",\n             \
        \   \"s3:List*\",\n                \"s3:Get*\"\n            ],\n         \
        \   \"Resource\": [\n                \"arn:aws:s3:::${aws_s3_bucket.sftp_bucket.bucket}\"\
        ,\n                \"arn:aws:s3:::${aws_s3_bucket.sftp_bucket.bucket}/*\"\n\
        \            ]\n        }\n    ]\n}"
      role: ${aws_iam_role.sftp_role.id}
- aws_transfer_server:
    sftp_server:
      identity_provider_type: SERVICE_MANAGED
      logging_role: ${aws_iam_role.sftp_role.arn}
- aws_transfer_user:
    sftp_user:
      home_directory: /${aws_s3_bucket.sftp_bucket.bucket}/sftp_user
      role: ${aws_iam_role.sftp_role.arn}
      server_id: ${aws_transfer_server.sftp_server.id}
      user_name: sftp_user
- aws_transfer_ssh_key:
    ssh_keys:
      body: ${var.ssh_key}
      server_id: ${aws_transfer_server.sftp_server.id}
      user_name: ${aws_transfer_user.sftp_user.user_name}
terraform:
- backend:
  - s3:
      encrypt: 'true'
  required_providers:
  - aws:
      source: hashicorp/aws
      version: ~> 5.0
---
output:
- sftp-server-endpoint:
    value: ${aws_transfer_server.sftp_server.endpoint}
---
variable:
- ssh_key:
    default: ''
    description: ssh key to access the endpoint
- s3_bucket_name:
    default: ''
    description: s3 bucket name where sftp server will host data
