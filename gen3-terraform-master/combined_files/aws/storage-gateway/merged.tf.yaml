resource:
- aws_instance:
    storage-gw-server:
      ami: ${var.ami_id}
      associate_public_ip_address: false
      instance_type: m4.xlarge
      key_name: ${var.key_name}
      root_block_device:
      - encrypted: true
        volume_size: ${var.size}
        volume_type: gp2
      subnet_id: ${data.aws_subnet.public_kube.id}
      tags:
        Environment: ${var.vpc_name}
        Organization: ${var.organization_name}
      vpc_security_group_ids:
      - ${aws_security_group.storage-gateway-sg.id}
- aws_ebs_volume:
    cache-disk:
      availability_zone: ${aws_instance.storage-gw-server.availability_zone}
      encrypted: true
      size: ${var.cache_size}
      tags:
        Environment: ${var.vpc_name}
        Organization: ${var.organization_name}
      type: gp2
- aws_volume_attachment:
    disk-attach:
      device_name: /dev/xvdb
      force_detach: true
      instance_id: ${aws_instance.storage-gw-server.id}
      volume_id: ${aws_ebs_volume.cache-disk.id}
- aws_security_group:
    storage-gateway-sg:
      egress:
      - cidr_blocks:
        - 0.0.0.0/0
        from_port: 0
        protocol: tcp
        to_port: 65535
      - cidr_blocks:
        - 0.0.0.0/0
        from_port: 0
        protocol: udp
        to_port: 65535
      ingress:
      - cidr_blocks:
        - 0.0.0.0/0
        from_port: 80
        protocol: tcp
        to_port: 80
      - cidr_blocks:
        - 0.0.0.0/0
        from_port: 20048
        protocol: tcp
        to_port: 20048
      - cidr_blocks:
        - 0.0.0.0/0
        from_port: 20048
        protocol: udp
        to_port: 20048
      - cidr_blocks:
        - 0.0.0.0/0
        from_port: 22
        protocol: tcp
        to_port: 22
      - cidr_blocks:
        - 0.0.0.0/0
        from_port: 111
        protocol: tcp
        to_port: 111
      - cidr_blocks:
        - 0.0.0.0/0
        from_port: 111
        protocol: udp
        to_port: 111
      - cidr_blocks:
        - 0.0.0.0/0
        from_port: 2049
        protocol: tcp
        to_port: 2049
      - cidr_blocks:
        - 0.0.0.0/0
        from_port: 2049
        protocol: udp
        to_port: 2049
      name: storage-gateway-sg
      tags:
        Environment: ${var.vpc_name}
        Organization: ${var.organization_name}
      vpc_id: ${data.aws_vpc.the_vpc.id}
- aws_storagegateway_gateway:
    storage-gateway:
      gateway_ip_address: ${aws_instance.storage-gw-server.private_ip}
      gateway_name: storage-gateway
      gateway_timezone: GMT
      gateway_type: FILE_S3
      tags:
        Environment: ${var.vpc_name}
        Organization: ${var.organization_name}
- aws_storagegateway_cache:
    storage-gateway-cache:
      disk_id: ${data.aws_storagegateway_local_disk.storage-gateway-data.id}
      gateway_arn: ${aws_storagegateway_gateway.storage-gateway.arn}
- aws_storagegateway_nfs_file_share:
    nfs_share:
      client_list:
      - 0.0.0.0/0
      gateway_arn: ${aws_storagegateway_gateway.storage-gateway.arn}
      location_arn: ${aws_s3_bucket.transfer-bucket.arn}
      role_arn: ${aws_iam_role.transfer-role.arn}
      tags:
        Environment: ${var.vpc_name}
        Organization: ${var.organization_name}
- aws_iam_role:
    transfer-role:
      assume_role_policy: "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n\
        \    {\n      \"Action\": \"sts:AssumeRole\",\n      \"Principal\": {\n  \
        \      \"Service\": \"storagegateway.amazonaws.com\"\n      },\n      \"Effect\"\
        : \"Allow\",\n      \"Sid\": \"\"\n    }\n  ]\n}"
      name: transfer-role
      tags:
        Environment: ${var.vpc_name}
        Organization: ${var.organization_name}
- aws_iam_policy:
    transfer-policy-sg:
      description: Allows access to storage gateway
      name: transfer-policy-sg
      policy: "{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n    \"\
        Action\": [\n      \"s3:GetAccelerateConfiguration\",\n      \"s3:GetBucketLocation\"\
        ,\n      \"s3:GetBucketVersioning\",\n      \"s3:ListBucket\",\n      \"s3:ListBucketVersions\"\
        ,\n      \"s3:ListBucketMultipartUploads\"\n    ],\n    \"Resource\": \"arn:aws:s3:::${aws_s3_bucket.transfer-bucket.bucket}\"\
        ,\n    \"Effect\": \"Allow\"\n  },\n  {\n    \"Action\": [\n      \"s3:AbortMultipartUpload\"\
        ,\n      \"s3:DeleteObject\",\n      \"s3:DeleteObjectVersion\",\n      \"\
        s3:GetObject\",\n      \"s3:GetObjectAcl\",\n      \"s3:GetObjectVersion\"\
        ,\n      \"s3:ListMultipartUploadParts\",\n      \"s3:PutObject\",\n     \
        \ \"s3:PutObjectAcl\"\n    ],\n    \"Resource\": \"arn:aws:s3:::${aws_s3_bucket.transfer-bucket.bucket}/*\"\
        ,\n    \"Effect\": \"Allow\"\n  }\n  ]\n}"
- aws_iam_policy_attachment:
    attach-policies:
      depends_on:
      - ${aws_iam_policy.transfer-policy-sg}
      name: storageGW-attachment
      policy_arn: ${aws_iam_policy.transfer-policy-sg.arn}
      roles:
      - ${aws_iam_role.transfer-role.name}
- aws_s3_bucket:
    transfer-bucket:
      bucket: ${var.s3_bucket}
      tags:
        Environment: ${var.vpc_name}
        Organization: ${var.organization_name}
- aws_s3_bucket_server_side_encryption_configuration:
    transfer-bucket:
      bucket: ${aws_s3_bucket.transfer-bucket.id}
      rule:
      - apply_server_side_encryption_by_default:
        - sse_algorithm: AES256
terraform:
- backend:
  - s3:
      encrypt: 'true'
  required_providers:
  - aws:
      source: hashicorp/aws
      version: ~> 5.0
---
data:
- aws_vpc:
    the_vpc:
      id: ${data.aws_vpcs.vpcs.ids[0]}
- aws_vpcs:
    vpcs:
      tags:
        Name: ${var.vpc_name}
- aws_subnet:
    public_kube:
      tags:
        Name: eks_public_2
      vpc_id: ${data.aws_vpc.the_vpc.id}
- aws_storagegateway_local_disk:
    storage-gateway-data:
      disk_path: ${aws_volume_attachment.disk-attach.device_name}
      gateway_arn: ${aws_storagegateway_gateway.storage-gateway.arn}
---
variable:
- vpc_name: {}
- ami_id:
    default: ''
- size:
    default: 80
- cache_size:
    default: 150
- s3_bucket:
    default: ''
- key_name:
    default: ''
- organization_name:
    default: Basic Services
